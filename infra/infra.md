## 서버 인프라를 지탱하는 기술 정리

용어 정리
- AP 서버 : 애플리케이션 서버, 동적 콘텐츠를 반환하는 서버를 말함. 에를 들면, Apache + mod_perl이 동작하는 웹 서버나 톰캣과 같은 애플리케이션 컨테이너가 동작하는 서버
- CDN : 콘텐츠를 전송하기 위한 네트워크 시스템. 전송 성능향상과 가용성 향상을 목적으로 함. 전 세계에 존재하는 캐시 서버 중에 클라이언트에 보다 가까운 캐시 서버를 선택해서 전송함으로써 성능향상을 실현하는 것이 구성상 특징.
- IPVS : (IP Virtual Server) : LVS의 성과물로 로드밸런서에 불가결한 부하분산 기능을 실현
- LVS : (Linux Virtual Server) : 리눅스에서 확장성이 있고 가용성이 높은 시스템을 만드는 것을 목표로 하고 있는 프로젝트.
- Netfilter : 리눅스 커널 상에서 네트워크 패킷을 조작하기 위한 프레임워크. 패킷 필터링 등을 수행하는 iptables나 로드밸런서를 실현하기 위한 IPVS도 Netfilter의 기능을 이용.
- NIC (Network Interface Card) : 본래는 네트워크 기능을 추가하기 위한 카드를 가리키는 용어지만, 확장카드나 온보드를 가리지 않고 네트워크 인터페이스를 총칭해서 사용되기도 한다. LAN 카드, 네트워크 카드, 네트워크 어댑터라고도 한다.
- OSI Layer Model : 데이터 통신을 위한 네트워크 계층을 설명한 모델
- VIP(Virtual Ip Address) : 물리적인 서버나 NIC가 아니라 유동적인 서비스나 역할에 할당된 IP 주소를 말함. 예를 들면, 로드밸런서의 경우에는 클라이언트의 요청을 받아들이는 IP 주소를 VIP라고 한다. 왜냐하면 이 IP 주소는 HTTP 등의 서비스에 관련된 것이기 때문이며, 또한 다중화를 위해 Active/Backup 구성을 할 경우에는 유일한 마스터가 되는 Active 측의 로드밸런서가 이 IP를 인계하기 때문이다. 가상주소, 가상 IP 주소라고도 한다.
- 가용성 : 시스템을 정지시키지 않음을 뜻함. 가용성이 높다라는 것은 해당 서비스는 거의 정지하지 않는다라는 의미. 
- 다중화 : 시스템의 구성요소를 여러 개 배치해서 하나가 고장 나서 정지해도 바로 교체해서 서비스가 멈추지 않도록 하는 것을 말한다. RAID가 그 전형적인 예. 이중화라고도 함
- 네트워크 부트 : 네트워크를 통해 부팅에 필요한 부트로더나 커널 이미지 등을 전달받아 기동하는 것.
- 네트워크 세그먼트 : 브로드캐스트 패킷이 전달되는 범위의 네트워크를 말함. 충돌 도메인과 동일한 의미였지만, 전 이중화 구성에서는 충돌이 발생하지 않으므로 네트워크 세그먼트 = 충돌 도메인이라고 하기 어려워짐.
- 단일 장애점(Single Point Of Failure) : 장애가 발생하면 시스템 전체가 정지해버리는 곳. 말하자면 시스템의 급소. 예를 들면, RAID나 전원과 같은 서버 내의 요소를 아무리 다중화하여도 모든 서버가 한 대의 스위칭 허브에 연결되어 있다면, 시스템 전체를 볼 때 그 스위치는 단일장애점이 됨.
- 데몬 : 백그라운드에서 지속적으로 실행되면서 특정 작업을 수행하는 프로그램, 예를 들어 httpd가 bind 등.

### 다중화의 기본

시스템의 다중화란 다음 단계를 실천하는 것.
1. 장애 상정
2. 장애에 대비해 예비 운용장비 준비
3. 장애가 발생했을 때 예비 운용장비로 교체할 수 있는 운용체제 정비.

Cold StandBy
- 현재 운용중인 장비에 장애가 발생하면, 예비 운용장비를 연결하는 운용체제
- 주의할 점은 현재 운용장비와 예비 운용장비의 설정은 동일하게 해두어야 함.
- 다중화된 시스템에서는 현재 운용장비와 예비 운용장비의 구성을 항상 같은 상태로 해두는 것이 정석.
- 라우터와 같은 네트워크 장비라면 운용 중에 빈번히 설정을 변경하거나 저장할 데이터가 그다지 많지 않으므로 Cold StandBy로의 운용은 현실적인 선택방법 중 하나.

Hot StandBy
- 다중화된 시스템에서는 현재 운용장비와 예비 운용장비의 구성을 항상 같은 상태로 해두는 것이 정석이지만, 웹 애플리케이션 서버의 경우 사이트 내용은 매일 갱신되며 애플리케이션, 운영체제의 버전업이 잦음. 따라서 다양한 갱신작업을 중지 되어 있는 예비 운용장비에 계속 수행하는 것은 매우 곤란함. 만일의 경우 예비 운용장비를 기동했을 때 컨텐츠 내용이 오래됬거나, 애플리케이션 버전이 낮다면 큰 문제가 됨.
- 이러한 문제로 인해 두 대의 서버를 항상 가동시키고, 늘 같은 상태로 유지하는 운용형태를 Hot StandBy라고 함. Cold StandBy의 경우 물리적으로 회선연결을 변경하거나 전원을 투입해야 하기 때문에 장애 시의 다운타임이 길어지기 쉽지만, Hot StandBy라면 즉시 교체하는 것이 가능.

장애극복(Failover)
- 현재 운용장비에 장애가 발생했을 때 자동적으로 예비 운용장비로 처리를 인계하는 것을 말함.
- 서버를 장애극복하기 위해서는 가상 IP 주소 (VIP)와 IP 주소 인계를 사용함.

장애검출
- ICMP 감시 (Layer 3)
  - ICMP 감시는 ICMP(Internet Control Message Protocol)의 echo 응답을 보내서 응답이 돌아오는지 체크. 가장 간단한 헬스체크지만, 웹 서비스가 다운된 경우(아파치가 중단한 경우)는 감지 불가
- 포트 감시 (Layer 4)
  - 포트 감시는 TCP로 접속을 시험해서 접속할 수 있는지 여부를 체크한다. 웹 서비스가 다운된 것은 감지할 수 있지만, 과부하 상태로 응답할 수 없다거나 에러를 반환하는 것은 감지할 수 없음.
- 서비스 감시 (Layer 7)
  - 실제로 HTTP 요청 등을 보내서 정상적인 응답이 돌아오는지 체크한다. 대부분의 이상을 감시할 수 있지만 경우에 따라서 서버에 부하를 유발함.

웹 서버, 라우터에 한하지 않고 헬스체크를 할 때에는 무엇을 확인하고자 하는가를 명확히 하는 것이 중요함.

IP 주소를 인계하는 원리
- IP 주소 인계란 단순히 IP 주소를 바꿔서 설정하는 것이 아니다. 시험 삼아 두 대의 서버에 같은 IP 주소를 할당하고 다른 머신에서 Ping을 날리면서 LAN 케이블을 차례로 빼고 꽂아본다. 그러면 아무리 케이블을 바꿔 꽂아도 어느 한 서버에만 Ping이 전송됨을 확인할 수 있다.
- LAN의 세계에서 IP주소가 아닌 NIC(Network Interface Card)에 고정적으로 할당되어 있는 MAC 주소를 사용해서 통신한다. 다른 서버에 패킷을 보낼 때에는 MAC 주소를 얻기 위해 ARP라는 프로토콜을 이용한다. ARP는 IP주소를 지정해서 MAC 주소를 조회하기 위한 프로토콜이다. 그러나 통신할 때마다 조회를 하는 것은 효율이 좋지 않으므로, 한번 얻은 MAC 주소는 ARP 테이블이 갱신될 때까지는 그 서버와 통신할 수 없다. 즉 IP 주소를 인계하기 위해서는 다른 서버의 ARP 테이블을 갱신해주어야 함.

### 웹 서버의 다중화

DNS 라운드로빈
- DNS 라운드로빈이란 DNS를 이용해서 하나의 서비스에 여러 대의 서버를 분산시키는 방법. 두 사람이 하나의 DNS서버에 접속할 때 2개의 서버에서 각각 다른 IP 주소를 반환하여 각 사람이 각 서버로 접속함.
- DNS 서버는 동일한 이름으로 여러 레코드를 등록시키면 질의할 때마다 다른 결과를 반환한다. 이 동작을 사용함으로써 여러 대의 서버에 처리를 분산시킬 수가 있다. 비교적 간단히 부하분산할 수 있지만 다음과 같은 문제가 있다.
- 서버의 수만큼 글로벌 주소가 필요
  - 수많은 서버로 부하분산하기 위해서는 IP주소를 많이 얻을 수 있는 서비스(회선)를 이용할 필요가 있다.
- 균등하게 분산되는 것은 아님
  - 이는 모바일 사이트 등에서 문제가 되는 경우가 있다. 휴대전화로부터의 접속은 캐리어 게이트웨이라고 하는 프록시 서버를 경유한다. 프록시 서버에서는 이름변환 결과가 일정시간 동안 캐싱되므로 같은 프록시 서버를 경유하는 접속은 항상 같은 서버로 전달된다. 따라서, 균등하게 접속이 분산되지 않고 특정 서버에만 집중할 가능성이 있다. 또한 PC용 웹브라우저도 DNS 질의 결과를 캐싱하기 때문에 균등하게 분산되지 않는다. DNS 레코드의 TTL(Time To Live)을 짧게 설정함으로써 어느정도 개선할 수 있지만, 반드시 TTL에 따라 캐시를 해제하는 것은 아니므로 주의할 필요가 있다.
- 서버가 다운돼도 감지하지 못함
  - DNS 서버는 웹 서버의 부하나 접속수 등의 상황에 따라 질의결과를 제어할 수가 없다. 웹 서버의 부하가 높아서 응답이 느려지거나 접속수가 꽉 차서 접속을 처리할 수 없는 상황인지를 전혀 감지할 수 없다. 즉 서버가 어떤 원인으로 다운되더라도 이를 검출하지 못하고 계속 부하분산한다. 

### 웹 서버의 다중화 IPVS를 이용한 로드밸런서

로드밸런서
- 로드밸런서의 동작
- 로드밸런서의 기능
- 로드밸런서의 도입장벽